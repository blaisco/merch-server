<div class="row">
  <div class="span3">
    <div class="facet">
    <h5>Categories</h5>
    <% facet_options = @facets[:product_type] %>
    <% @root.subtree.arrange(:order => :rank).each do |root, parents| %>
      <% parents.each do |parent, children| %>
        <ul>
          <li><b><%= link_to "#{parent[:name]}", '#' %></b></li>
          <% children.each do |cat, cat_children| %>
            <ul>
              <li><%= link_to "#{cat[:name]} (#{facet_options[cat[:id]]})", search_path(url_builder_multi(cat)) %></li>
            </ul>
          <% end %>
        </ul>
      <% end %>
    <% end %>
    </div>
  
    <% {
    :game => "Game", 
    :franchise => "Series", 
    :developer => "Developer", 
    :merchant => "Merchant"}.each do |facet, name| 
      facet_options = @facets[facet]
      # Facets include an "other" option (nil or 0). We dont want them, so they get removed.
      facet_options.delete(nil)
      facet_options.delete(0)
      unless facet_options.empty? %>
        <div class="facet">
          <h5><%= name %></h5>
          <ul>
          <% @facet_records = facet.to_s.classify.constantize.order(:name).find_all_by_id(facet_options.keys) %>
          <% @facet_records.each do |record| %>
            <li <%= "class=selected" if params_includes? record %>><%= link_to("#{record.name} (#{facet_options[record.id]})", search_path(url_builder_single(record))) %></li>
          <% end %>
          </ul>
        </div>
      <% end %>
    <% end %>
  </div>
  <div class="span13">
    <ul class="listings">
      <% products.each do |product| %>
        <li>
          <div class="listing-image">
            <%= link_to image_tag(product.primary_image.data(:small), :alt => product.name), product %>
          </div>
          <div class="listing-detail">
            <div class="listing-title"><%= link_to product.name, product %></div>
            <div class="listing-merchant"><%= link_to product.merchant.name, product.merchant %></div>
            <div class="listing-price">
              <span class="listing-amount"><%= product.max_figure.price.format %></span>
              <span class="listing-currency"><%= product.max_figure.price.currency %></span>
            </div>
          </div>
        </li>
      <% end %>
    </ul>
    <div style="clear: both"></div>

    <div class="pagination">
      <%= will_paginate @products, :renderer => PaginationListLinkRenderer, :class => nil %>
    </div>
  </div>
</div>
